<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with GTFS-Realtime and GBFS • mobdb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with GTFS-Realtime and GBFS">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mobdb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mobdb.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/gbfs-and-gtfs-rt.html">Working with GTFS-Realtime and GBFS</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jasonad123/mobdb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Working with GTFS-Realtime and GBFS</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jasonad123/mobdb/blob/main/vignettes/gbfs-and-gtfs-rt.Rmd" class="external-link"><code>vignettes/gbfs-and-gtfs-rt.Rmd</code></a></small>
      <div class="d-none name"><code>gbfs-and-gtfs-rt.Rmd</code></div>
    </div>

    
    
<p>The Mobility Database catalogs several types of transit and mobility
feeds. While GTFS Schedule feeds (formerly GTFS Static) make up the
majority of entries, they represent only part of the mobility data
landscape. Knowing when a bus is scheduled to arrive is useful, but
knowing whether it will actually arrive on time is even more
valuable.</p>
<p>The Database also contains GTFS Realtime and GBFS feeds, which
provide real-time operational data about transit systems and shared
mobility services.</p>
<p>As <code>mobdb</code> consumes data from the Mobility Database API, a
number of the functions in this package will provide valid outputs of
GTFS-Realtime and GBFS objects. However, it’s important to note that
support for GTFS-Realtime and GBFS in <code>mobdb</code> should be
considered <strong><em>experimental</em></strong> at this time and is
limited only to feed discovery.</p>
<div class="section level2">
<h2 id="gtfs-realtime-data-structure">GTFS-Realtime data structure<a class="anchor" aria-label="anchor" href="#gtfs-realtime-data-structure"></a>
</h2>
<p>GTFS-Realtime, as of the time of writing, supports four distinct feed
entities:</p>
<ul>
<li>
<code>TripUpdates</code> - fluctuations in the timetable -
<strong>“Bus X is delayed 2 minutes”</strong>
</li>
<li>
<code>ServiceAlerts</code> - problems/issues with an entity -
<strong>“Stop Y is closed”</strong>
</li>
<li>
<code>VehiclePositions</code> - vehicle location and sometimes speed
- <strong>“This bus is at position X at time Y”</strong>
</li>
<li>
<code>TripModifications</code> - detours that affect a set of trips
- <strong>“On X weekend, XYZ trips are on detour”</strong>
</li>
</ul>
<p>A detailed overview of what each feed entity does is available on the
<a href="https://gtfs.org/documentation/realtime/reference/" class="external-link">official
GTFS reference</a>.</p>
<p>GTFS-Realtime data is encoded and decoded as <a href="https://developers.google.com/protocol-buffers/" class="external-link">Protocol
Buffers</a>. In R, Protocol Buffers can be interpreted using the <a href="https://cran.r-project.org/web/packages/RProtoBuf/index.html" class="external-link">RProtoBuf</a>
package.</p>
<div class="section level3">
<h3 id="how-mobdb-handles-gtfs-realtime">How mobdb handles GTFS-Realtime<a class="anchor" aria-label="anchor" href="#how-mobdb-handles-gtfs-realtime"></a>
</h3>
<p><code>mobdb</code>, whether through <code><a href="../reference/feeds.html">feeds()</a></code> or
<code><a href="../reference/mobdb_search.html">mobdb_search()</a></code> will surface all available GTFS-Realtime
feeds on the Mobility Database. The URL retrieved from
<code><a href="../reference/mobdb_feed_url.html">mobdb_feed_url()</a></code> will be the protobuf endpoint url.</p>
<p><strong>Note:</strong> Many GTFS-Realtime producers <em>will</em>
require authentication to access their endpoints. Use the
<code>source_info</code> data frame to get authentication information
from the Mobility Database.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TransLink Vancouver GTFS-RT</span></span>
<span><span class="va">gtfs_rt_yvr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/feeds.html">feeds</a></span><span class="op">(</span>provider <span class="op">=</span> <span class="st">"TransLink Vancouver"</span>, data_type <span class="op">=</span> <span class="st">"gtfs_rt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read URL for GTFS-RT vehicle position</span></span>
<span><span class="fu"><a href="../reference/mobdb_feed_url.html">mobdb_feed_url</a></span><span class="op">(</span><span class="va">gtfs_rt_yvr</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># TransLink, like many agencies, requires authentication for their RT API</span></span>
<span><span class="co"># Get authentication information from Mobility Database</span></span>
<span><span class="va">yvr_rt_auth</span> <span class="op">&lt;-</span> <span class="va">gtfs_rt_yvr</span><span class="op">$</span><span class="va">source_info</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Get column names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">yvr_rt_auth</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get registration URL</span></span>
<span><span class="va">yvr_rt_auth</span><span class="op">$</span><span class="va">authentication_info_url</span></span>
<span></span>
<span><span class="co"># Get API key parameter</span></span>
<span><span class="va">yvr_rt_auth</span><span class="op">$</span><span class="va">api_key_parameter_name</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parsing-gtfs-realtime-with-rprotobuf">Parsing GTFS-Realtime with RProtoBuf<a class="anchor" aria-label="anchor" href="#parsing-gtfs-realtime-with-rprotobuf"></a>
</h3>
<p>Once you have the URL, you can use RProtoBuf to decode the Protocol
Buffer data:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/eddelbuettel/rprotobuf" class="external-link">RProtoBuf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">gtfs_rt_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/feeds.html">feeds</a></span><span class="op">(</span>provider <span class="op">=</span> <span class="st">"sample-agency"</span>, data_type <span class="op">=</span> <span class="st">"gtfs_rt"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read URL for GTFS-RT vehicle position</span></span>
<span><span class="va">example_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobdb_feed_url.html">mobdb_feed_url</a></span><span class="op">(</span><span class="va">gtfs_rt_example</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download and read the GTFS-RT .proto definition</span></span>
<span><span class="co"># Available at: https://gtfs.org/documentation/realtime/gtfs-realtime.proto</span></span>
<span><span class="va">proto_url</span> <span class="op">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/google/transit/master/gtfs-realtime/proto/gtfs-realtime.proto"</span></span>
<span><span class="va">proto_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".proto"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">proto_url</span>, <span class="va">proto_file</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">readProtoFiles</span><span class="op">(</span><span class="va">proto_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fetch and parse the feed</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="va">gtfs_rt_example</span>, <span class="st">"rb"</span><span class="op">)</span></span>
<span><span class="va">feed</span> <span class="op">&lt;-</span> <span class="fu">read</span><span class="op">(</span><span class="va">transit_realtime.FeedMessage</span>, <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">close</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access vehicle positions</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">entity</span> <span class="kw">in</span> <span class="va">feed</span><span class="op">$</span><span class="va">entity</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">entity</span><span class="op">$</span><span class="fu">has</span><span class="op">(</span><span class="st">"vehicle"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vehicle</span> <span class="op">&lt;-</span> <span class="va">entity</span><span class="op">$</span><span class="va">vehicle</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Vehicle ID:"</span>, <span class="va">vehicle</span><span class="op">$</span><span class="va">vehicle</span><span class="op">$</span><span class="va">id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Position:"</span>, <span class="va">vehicle</span><span class="op">$</span><span class="va">position</span><span class="op">$</span><span class="va">latitude</span>, <span class="st">","</span>, <span class="va">vehicle</span><span class="op">$</span><span class="va">position</span><span class="op">$</span><span class="va">longitude</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Timestamp:"</span>, <span class="va">vehicle</span><span class="op">$</span><span class="va">timestamp</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Note:</strong> The GTFS-Realtime Protocol Buffer definition
is maintained in the <a href="https://github.com/google/transit/tree/master/gtfs-realtime/proto" class="external-link">Google
Transit GitHub repository</a>. The example above downloads it
automatically, but you can also save it locally for repeated use.</p>
</div>
</div>
<div class="section level2">
<h2 id="gbfs-data-structure">GBFS data structure<a class="anchor" aria-label="anchor" href="#gbfs-data-structure"></a>
</h2>
<p>GBFS, or the General Bikeshare Feed Specification, is a “real-time,
pull-based, data specification that describes the current status of a
mobility system”. In other words, GBFS defines the status of shared
mobility systems like bikeshare or scooter share systems.</p>
<p>Unlike GTFS-Schedule or GTFS-Realtime, it is structured as a series
of JSON files.</p>
<p>As of the latest version (v3), two files are <em>required</em> of any
GBFS feed:</p>
<ul>
<li>
<code>gbfs.json</code> - an auto-discovery file that core
information about a shared mobility feed and shares what other files are
available</li>
<li>
<code>system_information.json</code> - defines core information
about the shared mobility <em>system</em>
</li>
</ul>
<p>Other feed types are conditionally required depending on the system
type (e.g. dock vs dockless), while others are fully optional.</p>
<p>A full list of the GBFS feed entities and their requirements are
available on the <a href="https://gbfs.org/documentation/reference/" class="external-link">official GBFS reference
documentation</a> or on the <a href="https://github.com/MobilityData/gbfs/blob/master/gbfs.md" class="external-link">GitHub
repo</a>.</p>
<div class="section level3">
<h3 id="how-mobdb-handles-gbfs">How mobdb handles GBFS<a class="anchor" aria-label="anchor" href="#how-mobdb-handles-gbfs"></a>
</h3>
<p><code>mobdb</code>, whether through <code><a href="../reference/feeds.html">feeds()</a></code> or
<code><a href="../reference/mobdb_search.html">mobdb_search()</a></code> will surface all available GBFS feeds on the
Mobility Database. The URL retrieved from <code><a href="../reference/mobdb_feed_url.html">mobdb_feed_url()</a></code>
will be the auto-discovery endpoint (i.e. <code>gbfs.json</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Search GBFS feeds in Vancouver</span></span>
<span><span class="va">gbfs_yvr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobdb_search.html">mobdb_search</a></span><span class="op">(</span><span class="st">"vancouver"</span>, data_type <span class="op">=</span> <span class="st">"gbfs"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">yvr_feed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobdb_feed_url.html">mobdb_feed_url</a></span><span class="op">(</span><span class="va">gbfs_yvr</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">yvr_feed</span></span></code></pre></div>
<p>This can then be passed on to <a href="https://cran.r-project.org/web/packages/jsonlite/index.html" class="external-link">jsonlite</a>
for parsing or to the dedicated <a href="https://gbfs.netlify.app/" class="external-link">gbfs</a> package for discovery.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/simonpcouch/gbfs" class="external-link">gbfs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">gbfs_yvr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobdb_search.html">mobdb_search</a></span><span class="op">(</span><span class="st">"vancouver"</span>, data_type <span class="op">=</span> <span class="st">"gbfs"</span><span class="op">)</span></span>
<span><span class="va">yvr_feed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mobdb_feed_url.html">mobdb_feed_url</a></span><span class="op">(</span><span class="va">gbfs_yvr</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">yvr_station_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gbfs/man/get_station_information.html" class="external-link">get_station_information</a></span><span class="op">(</span><span class="va">yvr_feed</span>, output <span class="op">=</span> <span class="st">"return"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>This vignette covered the basics of discovering GTFS-Realtime and
GBFS feeds using <code>mobdb</code>. For working with the actual feed
data:</p>
<ul>
<li>
<strong>GTFS-Realtime</strong>: Use the <a href="https://cran.r-project.org/web/packages/RProtoBuf/index.html" class="external-link">RProtoBuf</a>
package to decode Protocol Buffer data</li>
<li>
<strong>GBFS</strong>: Use the <a href="https://gbfs.netlify.app/" class="external-link">gbfs</a> package for streamlined access
to bikeshare data, or <a href="https://cran.r-project.org/web/packages/jsonlite/index.html" class="external-link">jsonlite</a>
for direct JSON parsing</li>
</ul>
<p>For discovering GTFS Schedule feeds and working with historical
transit data, see the main package documentation and other
vignettes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jason A.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
